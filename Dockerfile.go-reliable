# Use official Go Alpine image (most reliable)
FROM golang:1.21-alpine3.19

# Use older Alpine for stability
RUN apk update && apk add --no-cache ca-certificates

# Copy certificate
COPY mitmproxy-ca.pem /usr/local/share/ca-certificates/mitmproxy.crt

# Update certificates
RUN update-ca-certificates

ENV SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt

WORKDIR /app

# Create Go app
COPY <<'GOEOF' main.go
package main

import (
    "fmt"
    "io"
    "net/http"
    "os"
)

func main() {
    fmt.Println("ðŸ”§ Reliable HTTPS test without InsecureSkipVerify...")
    
    client := &http.Client{}
    
    req, _ := http.NewRequest("GET", "https://api.github.com/users/github", nil)
    
    if proxy := os.Getenv("HTTP_PROXY"); proxy != "" {
        fmt.Printf("âœ… Using proxy: %s\n", proxy)
    }
    
    resp, err := client.Do(req)
    if err != nil {
        fmt.Printf("âŒ Error: %v\n", err)
        return
    }
    defer resp.Body.Close()
    
    body, _ := io.ReadAll(resp.Body)
    fmt.Printf("ðŸ”§ RELIABLE SUCCESS! Got %d bytes\n", len(body))
}
GOEOF

CMD ["go", "run", "main.go"]
