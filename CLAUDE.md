# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a dynamic mock API server for the Firecracker API project, built in Go using Echo framework. It provides:
- Dynamic route loading from JSON configuration files
- Hot reload when config files change
- API response capture proxy for recording real API responses
- Support for path parameters and response templating

## Development Commands

```bash
# Run mock server standalone
go run cmd/main.go

# Run capture proxy (for recording real API responses)
go run cmd/capture/main.go

# Build the project
go build -o mock-server cmd/main.go
go build -o capture-proxy cmd/capture/main.go

# Run with Docker
docker build -t mock-api-server .
docker run -p 8090:8090 -v $(pwd)/configs:/app/configs mock-api-server
```

## Architecture

### Core Components

1. **Mock Server** (`cmd/main.go`)
   - Loads route configurations from JSON files in `configs/` directory
   - Watches for file changes and hot-reloads automatically
   - Supports dynamic path parameters like `/accounts/{id}`
   - Returns 404 for undefined routes

2. **Capture Proxy** (`cmd/capture/main.go`)
   - Intercepts real API calls and records responses
   - Automatically normalizes paths (IDs become `{id}` placeholders)
   - Groups captures by service (accounts, wallet, ledger, etc.)
   - Outputs JSON files compatible with mock server format

### Key Files
- `configs/*.json` - Route definition files (hot-reloaded)
- `captured/*.json` - Captured API responses (generated by proxy)

## Route Configuration Format

Routes are defined in JSON files under `configs/`:

```json
{
  "routes": [
    {
      "method": "GET",
      "path": "/v2/accounts/{id}",
      "status": 200,
      "headers": {"Content-Type": "application/json"},
      "delay": 100,
      "response": {
        "id": "{{id}}",
        "data": "value"
      }
    }
  ]
}
```

Path parameters use `{param}` syntax and are replaced with `{{param}}` in responses.

## Environment Variables

**Mock Server:**
- `PORT` - Server port (default: 8090)
- `CONFIG_PATH` - Config directory (default: ./configs)

**Capture Proxy:**
- `CAPTURE_PORT` - Proxy port (default: 8091)
- `OUTPUT_DIR` - Capture output directory (default: ./captured)
- `*_API_URL` - Real API endpoints to proxy (ACCOUNTS_API_URL, WALLET_API_URL, etc.)

## Capture Workflow

1. Set real API URLs as environment variables
2. Run capture proxy: `go run cmd/capture/main.go`
3. Point your application to proxy URLs (e.g., http://localhost:8091/accounts)
4. Use the application to generate traffic
5. Save captures: `curl http://localhost:8091/capture/save`
6. Copy captured JSON from `captured/` to `configs/` for use as mocks

## Testing

No formal test suite currently exists. Testing is done manually by:
1. Adding/modifying JSON config files in `configs/`
2. Verifying routes respond correctly via curl or application
3. Checking hot-reload by modifying configs while server runs