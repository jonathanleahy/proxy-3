# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a dynamic mock API server for the Firecracker API project, built in Go using Echo framework (Go 1.21). It provides:
- Dynamic route loading from JSON configuration files
- Hot reload when config files change using fsnotify
- API response capture proxy for recording real API responses
- **NEW**: MITM proxy for full HTTPS content capture using Docker/mitmproxy
- Support for path parameters and response templating
- Automatic path normalization (IDs become `{id}` placeholders)
- Works on restricted machines without admin access (using environment variables)

## Development Commands

```bash
# Run mock server standalone (port 8090)
go run cmd/main.go

# Run capture proxy for recording real API responses (port 8091)
go run cmd/capture/main.go

# Run MITM proxy for full HTTPS capture (port 8080)
docker-compose --profile mitm up

# Extract CA certificate for MITM (no admin needed)
./scripts/get-mitm-cert.sh

# Quick capture setup with script
./capture-real-apis.sh intercept  # Creates run-capture-proxy.sh

# Build binaries
go build -o mock-server cmd/main.go
go build -o capture-proxy cmd/capture/main.go

# Run with Docker
docker build -t mock-api-server .
docker run -p 8090:8090 -v $(pwd)/configs:/app/configs mock-api-server

# Manage services (if using run-with-mocks.sh)
./run-with-mocks.sh start   # Start all services
./run-with-mocks.sh stop    # Stop services
./run-with-mocks.sh capture # Start capture mode
```

## Architecture

### Core Components

1. **Mock Server** (`cmd/main.go`)
   - Loads route configurations from JSON files in `configs/` directory
   - Watches for file changes and hot-reloads automatically
   - Supports dynamic path parameters like `/accounts/{id}`
   - Returns 404 for undefined routes

2. **Capture Proxy** (`cmd/capture/main.go`)
   - Intercepts real API calls and records responses
   - Automatically normalizes paths (IDs become `{id}` placeholders)
   - Groups captures by service (accounts, wallet, ledger, etc.)
   - Outputs JSON files compatible with mock server format
   - Supports HTTPS via CONNECT tunneling (can't decrypt content)

3. **MITM Proxy** (Docker with mitmproxy)
   - Full HTTPS content decryption and capture
   - Automatic certificate generation
   - Works without admin rights (using environment variables)
   - Python script (`scripts/mitm_capture.py`) for custom capture logic
   - Same output format as capture proxy for compatibility

### Key Files
- `configs/*.json` - Route definition files (hot-reloaded)
- `captured/*.json` - Captured API responses (generated by proxy)

## Route Configuration Format

Routes are defined in JSON files under `configs/`:

```json
{
  "routes": [
    {
      "method": "GET",
      "path": "/v2/accounts/{id}",
      "status": 200,
      "headers": {"Content-Type": "application/json"},
      "delay": 100,
      "response": {
        "id": "{{id}}",
        "data": "value"
      }
    }
  ]
}
```

Path parameters use `{param}` syntax and are replaced with `{{param}}` in responses.

## Environment Variables

**Mock Server:**
- `PORT` - Server port (default: 8090)
- `CONFIG_PATH` - Config directory (default: ./configs)

**Capture Proxy:**
- `CAPTURE_PORT` - Proxy port (default: 8091)
- `OUTPUT_DIR` - Capture output directory (default: ./captured)
- `TRANSPARENT_MODE` - Enable transparent proxy mode (default: false)
- `*_API_URL` - Real API endpoints to proxy (ACCOUNTS_API_URL, WALLET_API_URL, etc.)

**MITM Proxy (for restricted environments):**
- `SSL_CERT_FILE` - Path to CA certificate for HTTPS trust (no admin needed)
- `REQUESTS_CA_BUNDLE` - Python requests library CA bundle
- `NODE_EXTRA_CA_CERTS` - Node.js additional CA certificates
- `HTTP_PROXY` / `HTTPS_PROXY` - Proxy settings for applications

## Capture Workflow

### Quick Start (Recommended)
```bash
# 1. Generate capture script
./capture-real-apis.sh intercept

# 2. Edit run-capture-proxy.sh with real API URLs
# 3. Run proxy
./run-capture-proxy.sh

# 4. Update app's .env to use proxy
# 5. Generate traffic
# 6. Save captures
curl http://localhost:8091/capture/save
```

### Manual Setup
1. Set real API URLs as environment variables
2. Run capture proxy: `go run cmd/capture/main.go`
3. Point your application to proxy URLs (e.g., http://localhost:8091/accounts)
4. Use the application to generate traffic
5. Save captures: `curl http://localhost:8091/capture/save`
6. Check status: `curl http://localhost:8091/capture/status`
7. Copy captured JSON from `captured/` to `configs/` for use as mocks

### Capture Proxy Features
- Automatically normalizes paths (numeric IDs â†’ `{id}`)
- Groups captures by service type
- Preserves request bodies for POST/PUT/PATCH
- Outputs mock-server-compatible JSON format

## Testing

No formal test suite currently exists. Testing is done manually by:
1. Adding/modifying JSON config files in `configs/`
2. Verifying routes respond correctly via curl or application
3. Checking hot-reload by modifying configs while server runs

## Dependencies

- Go 1.21+
- github.com/labstack/echo/v4 (HTTP server framework)
- github.com/fsnotify/fsnotify (file system notifications for hot reload)