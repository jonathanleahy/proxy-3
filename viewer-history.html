<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock API Viewer - History View</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .json-key { color: #0969da; }
        .json-string { color: #032f62; }
        .json-number { color: #0550ae; }
        .json-boolean { color: #cf222e; }
        .json-null { color: #6e7781; }
        pre { tab-size: 2; }
        .highlight { background-color: #fff3cd; }
        .tab-active { 
            background-color: #3b82f6; 
            color: white; 
        }
        .tab-inactive { 
            background-color: #e5e7eb; 
            color: #374151; 
        }
        .history-item {
            transition: all 0.2s;
        }
        .history-item:hover {
            background-color: #f3f4f6;
        }
        .history-item.selected {
            background-color: #dbeafe;
            border-left: 3px solid #3b82f6;
        }
        .detail-panel {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .timestamp {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container-fluid mx-auto px-4 py-4 max-w-full">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h1 class="text-2xl font-bold text-gray-800 mb-3">üé≠ Mock API Viewer</h1>
            
            <!-- Status Bar -->
            <div class="flex flex-wrap gap-4 mb-3">
                <div class="flex items-center gap-2">
                    <div id="mockStatus" class="w-3 h-3 rounded-full bg-gray-400"></div>
                    <span class="text-sm text-gray-600">Mock Server: <span id="mockPort">Checking...</span></span>
                </div>
                <div class="flex items-center gap-2">
                    <div id="proxyStatus" class="w-3 h-3 rounded-full bg-gray-400"></div>
                    <span class="text-sm text-gray-600">Capture Proxy: <span id="proxyPort">Checking...</span></span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-600">Total Captures: <span id="totalCaptures" class="font-bold">0</span></span>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="flex gap-2 mb-4">
                <button id="tabFiles" onclick="switchTab('files')" class="px-4 py-2 rounded-lg tab-active transition">
                    üìÅ Files View
                </button>
                <button id="tabHistory" onclick="switchTab('history')" class="px-4 py-2 rounded-lg tab-inactive transition">
                    üìú History View
                </button>
            </div>

            <!-- Controls -->
            <div class="flex flex-wrap gap-3">
                <select id="sourceSelect" class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <option value="live">üî¥ Live Captures</option>
                    <option value="configs">üìÅ Configs</option>
                    <option value="captured">üì∏ Captured</option>
                </select>
                
                <button onclick="loadData()" class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm">
                    üîÑ Refresh
                </button>
                
                <button onclick="saveCaptures()" class="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm">
                    üíæ Save
                </button>
                
                <button onclick="clearCaptures()" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm">
                    üóëÔ∏è Clear
                </button>

                <!-- History-specific controls -->
                <div id="historyControls" class="hidden gap-3 flex items-center">
                    <input type="date" id="dateFilter" class="px-3 py-2 border rounded-lg text-sm" onchange="filterHistory()">
                    <input type="text" id="pathFilter" placeholder="Filter by path..." class="px-3 py-2 border rounded-lg text-sm" onkeyup="filterHistory()">
                    <select id="methodFilter" class="px-3 py-2 border rounded-lg text-sm" onchange="filterHistory()">
                        <option value="">All Methods</option>
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Files View -->
        <div id="filesView" class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- File List -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700">Files</h2>
                    <div id="fileList" class="space-y-2 max-h-[600px] overflow-y-auto">
                        <div class="text-gray-500 text-sm">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Route Details -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700">Routes</h2>
                    <div id="routeList" class="space-y-3 max-h-[600px] overflow-y-auto">
                        <div class="text-gray-500 text-sm">Select a file to view routes</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History View -->
        <div id="historyView" class="hidden grid grid-cols-12 gap-4">
            <!-- History List (Left Side) -->
            <div class="col-span-4 bg-white rounded-lg shadow-md p-4">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-semibold text-gray-700">Capture History</h2>
                    <span class="text-sm text-gray-500">
                        <span id="filteredCount">0</span> / <span id="totalCount">0</span>
                    </span>
                </div>
                <div id="historyList" class="space-y-1 max-h-[calc(100vh-250px)] overflow-y-auto">
                    <div class="text-gray-500 text-sm p-4">No captures found</div>
                </div>
            </div>

            <!-- Detail View (Right Side) -->
            <div class="col-span-8 bg-white rounded-lg shadow-md p-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">Request Details</h2>
                <div id="detailView" class="detail-panel">
                    <div class="text-gray-500 text-sm p-8 text-center">
                        Select a capture from the history to view details
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const MOCK_SERVER = 'http://localhost:8090';
        const PROXY_SERVER = 'http://localhost:8091';
        
        let currentTab = 'files';
        let allRoutes = [];
        let allFiles = {};
        let historyData = [];
        let selectedHistoryItem = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkStatus();
            loadData();
            setInterval(checkStatus, 5000);
        });

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.getElementById('tabFiles').className = tab === 'files' 
                ? 'px-4 py-2 rounded-lg tab-active transition' 
                : 'px-4 py-2 rounded-lg tab-inactive transition';
            document.getElementById('tabHistory').className = tab === 'history' 
                ? 'px-4 py-2 rounded-lg tab-active transition' 
                : 'px-4 py-2 rounded-lg tab-inactive transition';
            
            // Show/hide views
            document.getElementById('filesView').className = tab === 'files' 
                ? 'grid grid-cols-1 lg:grid-cols-3 gap-4' 
                : 'hidden';
            document.getElementById('historyView').className = tab === 'history' 
                ? 'grid grid-cols-12 gap-4' 
                : 'hidden';
            
            // Show/hide history controls
            document.getElementById('historyControls').className = tab === 'history' 
                ? 'flex gap-3 items-center' 
                : 'hidden';
            
            // Load appropriate data
            if (tab === 'history') {
                loadHistoryData();
            } else {
                loadFiles();
            }
        }

        // Check server status
        async function checkStatus() {
            // Check mock server
            try {
                const response = await fetch(MOCK_SERVER, { mode: 'no-cors' });
                document.getElementById('mockStatus').className = 'w-3 h-3 rounded-full bg-green-500';
                document.getElementById('mockPort').textContent = '8090 ‚úì';
            } catch {
                document.getElementById('mockStatus').className = 'w-3 h-3 rounded-full bg-red-500';
                document.getElementById('mockPort').textContent = 'Offline';
            }

            // Check proxy
            try {
                const response = await fetch(`${PROXY_SERVER}/capture/status`);
                const data = await response.json();
                document.getElementById('proxyStatus').className = 'w-3 h-3 rounded-full bg-green-500';
                document.getElementById('proxyPort').textContent = `8091 ‚úì`;
                document.getElementById('totalCaptures').textContent = data.captured_routes || 0;
            } catch {
                document.getElementById('proxyStatus').className = 'w-3 h-3 rounded-full bg-red-500';
                document.getElementById('proxyPort').textContent = 'Offline';
            }
        }

        // Load data based on current tab
        function loadData() {
            if (currentTab === 'history') {
                loadHistoryData();
            } else {
                loadFiles();
            }
        }

        // Load history data
        async function loadHistoryData() {
            const source = document.getElementById('sourceSelect').value;
            historyData = [];
            
            try {
                if (source === 'live') {
                    // Load from proxy
                    const response = await fetch(`${PROXY_SERVER}/capture/list`);
                    const data = await response.json();
                    historyData = parseProxyCaptures(data);
                } else {
                    // Load from files
                    const response = await fetch(`${MOCK_SERVER}/api/files/${source}`);
                    const files = await response.json();
                    
                    // Load each file and extract routes with timestamps
                    for (const file of files) {
                        const fileResponse = await fetch(`${MOCK_SERVER}/api/file/${source}/${file}`);
                        const fileData = await fileResponse.json();
                        if (fileData.routes) {
                            fileData.routes.forEach(route => {
                                historyData.push({
                                    timestamp: route.timestamp || extractTimestampFromFilename(file) || new Date().toISOString(),
                                    method: route.method,
                                    path: route.path,
                                    status: route.status || 200,
                                    description: route.description || '',
                                    file: file,
                                    data: route
                                });
                            });
                        }
                    }
                }
                
                // Sort by timestamp (newest first)
                historyData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                displayHistory();
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('historyList').innerHTML = 
                    '<div class="text-red-500 text-sm p-4">Error loading history data</div>';
            }
        }

        // Parse proxy captures
        function parseProxyCaptures(data) {
            const captures = [];
            if (data && data.captures) {
                Object.entries(data.captures).forEach(([path, methods]) => {
                    Object.entries(methods).forEach(([method, capture]) => {
                        captures.push({
                            timestamp: capture.timestamp || new Date().toISOString(),
                            method: method,
                            path: path,
                            status: capture.status || 200,
                            description: capture.description || '',
                            data: capture
                        });
                    });
                });
            }
            return captures;
        }

        // Extract timestamp from filename
        function extractTimestampFromFilename(filename) {
            // Try to extract date from patterns like: mitm_captured_20250905_123456.json
            const match = filename.match(/(\d{8})_(\d{6})/);
            if (match) {
                const date = match[1];
                const time = match[2];
                const year = date.substr(0, 4);
                const month = date.substr(4, 2);
                const day = date.substr(6, 2);
                const hour = time.substr(0, 2);
                const min = time.substr(2, 2);
                const sec = time.substr(4, 2);
                return `${year}-${month}-${day}T${hour}:${min}:${sec}Z`;
            }
            return null;
        }

        // Display history list
        function displayHistory() {
            const filteredData = filterHistoryData();
            const historyList = document.getElementById('historyList');
            
            document.getElementById('totalCount').textContent = historyData.length;
            document.getElementById('filteredCount').textContent = filteredData.length;
            
            if (filteredData.length === 0) {
                historyList.innerHTML = '<div class="text-gray-500 text-sm p-4">No captures found</div>';
                return;
            }
            
            historyList.innerHTML = filteredData.map((item, index) => {
                const date = new Date(item.timestamp);
                const timeStr = date.toLocaleTimeString();
                const dateStr = date.toLocaleDateString();
                
                return `
                    <div class="history-item p-3 border-b cursor-pointer ${selectedHistoryItem === index ? 'selected' : ''}" 
                         onclick="selectHistoryItem(${index})">
                        <div class="flex justify-between items-start mb-1">
                            <span class="timestamp text-gray-600">${timeStr}</span>
                            <span class="text-xs text-gray-500">${dateStr}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 text-xs font-semibold rounded ${getMethodColor(item.method)}">
                                ${item.method}
                            </span>
                            <span class="text-sm truncate flex-1">${item.path}</span>
                        </div>
                        ${item.description ? `<div class="text-xs text-gray-500 mt-1">${item.description}</div>` : ''}
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs ${getStatusColor(item.status)}">${item.status}</span>
                            ${item.file ? `<span class="text-xs text-gray-400">${item.file}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter history data
        function filterHistoryData() {
            const dateFilter = document.getElementById('dateFilter').value;
            const pathFilter = document.getElementById('pathFilter').value.toLowerCase();
            const methodFilter = document.getElementById('methodFilter').value;
            
            return historyData.filter(item => {
                if (dateFilter) {
                    const itemDate = new Date(item.timestamp).toISOString().split('T')[0];
                    if (itemDate !== dateFilter) return false;
                }
                if (pathFilter && !item.path.toLowerCase().includes(pathFilter)) return false;
                if (methodFilter && item.method !== methodFilter) return false;
                return true;
            });
        }

        // Filter history
        function filterHistory() {
            displayHistory();
        }

        // Select history item
        function selectHistoryItem(index) {
            selectedHistoryItem = index;
            const filteredData = filterHistoryData();
            const item = filteredData[index];
            
            displayHistory(); // Refresh to show selection
            displayDetail(item);
        }

        // Display detail view
        function displayDetail(item) {
            const detailView = document.getElementById('detailView');
            
            const date = new Date(item.timestamp);
            const fullDateTime = date.toLocaleString();
            
            detailView.innerHTML = `
                <div class="space-y-4">
                    <!-- Header -->
                    <div class="border-b pb-3">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="px-3 py-1 font-semibold rounded ${getMethodColor(item.method)}">
                                ${item.method}
                            </span>
                            <span class="text-lg font-mono">${item.path}</span>
                        </div>
                        <div class="flex gap-4 text-sm text-gray-600">
                            <span>üìÖ ${fullDateTime}</span>
                            <span class="${getStatusColor(item.status)}">Status: ${item.status}</span>
                            ${item.file ? `<span>üìÅ ${item.file}</span>` : ''}
                        </div>
                        ${item.description ? `<div class="mt-2 text-sm text-gray-700">${item.description}</div>` : ''}
                    </div>
                    
                    <!-- Headers -->
                    ${item.data.headers ? `
                        <div>
                            <h3 class="font-semibold mb-2">Headers</h3>
                            <div class="bg-gray-50 p-3 rounded">
                                ${Object.entries(item.data.headers).map(([key, value]) => 
                                    `<div class="text-sm"><span class="font-mono text-blue-600">${key}:</span> ${value}</div>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Request Body -->
                    ${item.data.request ? `
                        <div>
                            <h3 class="font-semibold mb-2">Request Body</h3>
                            <pre class="bg-gray-900 text-gray-100 p-4 rounded overflow-x-auto text-sm">${syntaxHighlight(item.data.request)}</pre>
                        </div>
                    ` : ''}
                    
                    <!-- Response -->
                    ${item.data.response ? `
                        <div>
                            <h3 class="font-semibold mb-2">Response</h3>
                            <pre class="bg-gray-900 text-gray-100 p-4 rounded overflow-x-auto text-sm">${syntaxHighlight(item.data.response)}</pre>
                        </div>
                    ` : ''}
                    
                    <!-- Additional Info -->
                    ${item.data.delay ? `
                        <div class="text-sm text-gray-600">
                            ‚è±Ô∏è Response delay: ${item.data.delay}ms
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Get method color class
        function getMethodColor(method) {
            const colors = {
                'GET': 'bg-green-100 text-green-800',
                'POST': 'bg-blue-100 text-blue-800',
                'PUT': 'bg-yellow-100 text-yellow-800',
                'DELETE': 'bg-red-100 text-red-800',
                'PATCH': 'bg-purple-100 text-purple-800'
            };
            return colors[method] || 'bg-gray-100 text-gray-800';
        }

        // Get status color class
        function getStatusColor(status) {
            if (status >= 200 && status < 300) return 'text-green-600';
            if (status >= 300 && status < 400) return 'text-yellow-600';
            if (status >= 400 && status < 500) return 'text-orange-600';
            if (status >= 500) return 'text-red-600';
            return 'text-gray-600';
        }

        // Original file-based functions
        async function loadFiles() {
            const source = document.getElementById('sourceSelect').value;
            
            try {
                if (source === 'live') {
                    await loadLiveCaptures();
                } else {
                    const files = await fetchFileList(source);
                    displayFileList(files);
                }
            } catch (error) {
                console.error('Error loading files:', error);
                document.getElementById('fileList').innerHTML = 
                    '<div class="text-red-500 text-sm">Error loading files</div>';
            }
        }

        async function fetchFileList(directory) {
            const response = await fetch(`${MOCK_SERVER}/api/files/${directory}`);
            return await response.json();
        }

        function displayFileList(files) {
            const fileList = document.getElementById('fileList');
            
            if (files.length === 0) {
                fileList.innerHTML = '<div class="text-gray-500 text-sm">No files found</div>';
                return;
            }
            
            fileList.innerHTML = files.map(file => `
                <div class="p-2 hover:bg-gray-100 rounded cursor-pointer border border-gray-200" 
                     onclick="loadFile('${file}')">
                    <div class="font-mono text-sm">${file}</div>
                </div>
            `).join('');
        }

        async function loadFile(filename) {
            const source = document.getElementById('sourceSelect').value;
            
            try {
                const response = await fetch(`${MOCK_SERVER}/api/file/${source}/${filename}`);
                const data = await response.json();
                
                displayRoutes(data.routes || []);
            } catch (error) {
                console.error('Error loading file:', error);
            }
        }

        function displayRoutes(routes) {
            const routeList = document.getElementById('routeList');
            
            if (!routes || routes.length === 0) {
                routeList.innerHTML = '<div class="text-gray-500 text-sm">No routes found</div>';
                return;
            }
            
            routeList.innerHTML = routes.map(route => `
                <div class="border rounded-lg p-3 hover:shadow-md transition">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="px-2 py-1 text-xs font-semibold rounded ${getMethodColor(route.method)}">
                            ${route.method}
                        </span>
                        <span class="font-mono text-sm">${route.path}</span>
                    </div>
                    ${route.description ? `<div class="text-sm text-gray-600 mb-2">${route.description}</div>` : ''}
                    <div class="text-xs text-gray-500">Status: ${route.status || 200}</div>
                </div>
            `).join('');
        }

        async function loadLiveCaptures() {
            try {
                const response = await fetch(`${PROXY_SERVER}/capture/list`);
                const data = await response.json();
                
                const routes = [];
                Object.entries(data.captures || {}).forEach(([path, methods]) => {
                    Object.entries(methods).forEach(([method, capture]) => {
                        routes.push({
                            method: method,
                            path: path,
                            status: capture.status,
                            response: capture.response,
                            description: capture.description
                        });
                    });
                });
                
                displayRoutes(routes);
            } catch (error) {
                document.getElementById('routeList').innerHTML = 
                    '<div class="text-red-500 text-sm">Capture proxy not running</div>';
            }
        }

        // Action functions
        async function saveCaptures() {
            try {
                const response = await fetch(`${PROXY_SERVER}/capture/save`, { method: 'POST' });
                const result = await response.json();
                alert(`Saved to: ${result.file}`);
                loadData();
            } catch (error) {
                alert('Error: Proxy server not running');
            }
        }

        async function clearCaptures() {
            if (confirm('Clear all captured routes?')) {
                try {
                    await fetch(`${PROXY_SERVER}/capture/clear`, { method: 'POST' });
                    loadData();
                } catch (error) {
                    alert('Error: Proxy server not running');
                }
            }
        }

        // JSON syntax highlighting
        function syntaxHighlight(obj) {
            const json = JSON.stringify(obj, null, 2);
            return json
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, 
                function (match) {
                    let cls = 'json-number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'json-key';
                        } else {
                            cls = 'json-string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'json-boolean';
                    } else if (/null/.test(match)) {
                        cls = 'json-null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
        }
    </script>
</body>
</html>