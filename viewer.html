<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock API Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .json-key { color: #0969da; }
        .json-string { color: #032f62; }
        .json-number { color: #0550ae; }
        .json-boolean { color: #cf222e; }
        .json-null { color: #6e7781; }
        pre { tab-size: 2; }
        .highlight { background-color: #fff3cd; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">üé≠ Mock API Viewer</h1>
            
            <!-- Status Bar -->
            <div class="flex flex-wrap gap-4 mb-4">
                <div class="flex items-center gap-2">
                    <div id="mockStatus" class="w-3 h-3 rounded-full bg-gray-400"></div>
                    <span class="text-sm text-gray-600">Mock Server: <span id="mockPort">Checking...</span></span>
                </div>
                <div class="flex items-center gap-2">
                    <div id="proxyStatus" class="w-3 h-3 rounded-full bg-gray-400"></div>
                    <span class="text-sm text-gray-600">Capture Proxy: <span id="proxyPort">Checking...</span></span>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex flex-wrap gap-4">
                <select id="sourceSelect" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="live">üî¥ Live Captures (In Memory)</option>
                    <option value="configs">üìÅ Configs (Active Mocks)</option>
                    <option value="captured">üì∏ Captured (Saved Files)</option>
                </select>
                
                <button onclick="loadFiles()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                    üîÑ Refresh
                </button>
                
                <button onclick="saveCaptures()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                    üíæ Save Captures
                </button>
                
                <button onclick="clearCaptures()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                    üóëÔ∏è Clear Captures
                </button>
                
                <button onclick="copyToConfigs()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition">
                    üìã Copy to Configs
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- File List -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h2 class="text-lg font-semibold mb-4 text-gray-700">Files</h2>
                    <div id="fileList" class="space-y-2 max-h-[600px] overflow-y-auto">
                        <div class="text-gray-500 text-sm">Loading...</div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="bg-white rounded-lg shadow-md p-4 mt-4">
                    <h2 class="text-lg font-semibold mb-4 text-gray-700">Statistics</h2>
                    <div id="stats" class="space-y-2 text-sm">
                        <div>Total Routes: <span class="font-mono">0</span></div>
                        <div>Total Files: <span class="font-mono">0</span></div>
                    </div>
                </div>
            </div>

            <!-- Route Details -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-700">Routes</h2>
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Search routes..."
                            class="px-3 py-1 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            onkeyup="filterRoutes()"
                        />
                    </div>
                    
                    <div id="routeList" class="space-y-4 max-h-[700px] overflow-y-auto">
                        <div class="text-gray-500 text-sm">Select a file to view routes</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const MOCK_SERVER = 'http://localhost:8090';
        const PROXY_SERVER = window.location.origin; // Use same server as viewer
        
        let currentFile = null;
        let allRoutes = [];
        let allFiles = {};

        // Check server status
        async function checkStatus() {
            // Check mock server
            try {
                const response = await fetch(MOCK_SERVER, { mode: 'no-cors' });
                document.getElementById('mockStatus').className = 'w-3 h-3 rounded-full bg-green-500';
                document.getElementById('mockPort').textContent = '8090 ‚úì';
            } catch {
                document.getElementById('mockStatus').className = 'w-3 h-3 rounded-full bg-red-500';
                document.getElementById('mockPort').textContent = 'Offline';
            }

            // Check proxy
            try {
                const response = await fetch(`${PROXY_SERVER}/capture/status`);
                const data = await response.json();
                document.getElementById('proxyStatus').className = 'w-3 h-3 rounded-full bg-green-500';
                document.getElementById('proxyPort').textContent = `8090 ‚úì (${data.captured_routes} captured)`;
            } catch {
                document.getElementById('proxyStatus').className = 'w-3 h-3 rounded-full bg-red-500';
                document.getElementById('proxyPort').textContent = 'Offline';
            }
        }

        // Load files from directory
        async function loadFiles() {
            const source = document.getElementById('sourceSelect').value;
            
            try {
                if (source === 'live') {
                    // Load live captures from proxy
                    await loadLiveCaptures();
                } else {
                    // Load files from directory
                    const files = await fetchFileList(source);
                    displayFileList(files);
                }
                updateStats();
            } catch (error) {
                console.error('Error loading files:', error);
                document.getElementById('fileList').innerHTML = 
                    '<div class="text-red-500 text-sm">Error loading files</div>';
            }
        }

        // Load live captures from capture proxy
        async function loadLiveCaptures() {
            try {
                const response = await fetch(`${PROXY_SERVER}/capture/live`);
                const data = await response.json();
                
                // Display in file list
                document.getElementById('fileList').innerHTML = `
                    <div class="p-3 border rounded-lg bg-red-50 border-red-400">
                        <div class="font-medium text-sm">üî¥ Live Captures</div>
                        <div class="text-xs text-gray-600">${data.count} routes captured</div>
                        <div class="text-xs text-green-600 mt-1">Auto-refreshing...</div>
                    </div>
                `;
                
                // Display routes
                displayRoutes(data.routes || []);
                
                // Update current data
                allRoutes = data.routes || [];
                allFiles['live'] = data;
                
                // Auto-refresh every 3 seconds if live is selected
                if (document.getElementById('sourceSelect').value === 'live') {
                    setTimeout(() => {
                        if (document.getElementById('sourceSelect').value === 'live') {
                            loadFiles();
                        }
                    }, 3000);
                }
            } catch (error) {
                console.error('Error loading live captures:', error);
                document.getElementById('fileList').innerHTML = 
                    '<div class="text-red-500 text-sm">Capture proxy not running</div>';
                document.getElementById('routeList').innerHTML = 
                    '<div class="text-gray-500 text-sm">Start capture proxy to see live captures</div>';
            }
        }

        // Fetch file list from API
        async function fetchFileList(directory) {
            try {
                const response = await fetch(`${MOCK_SERVER}/api/files/${directory}`);
                if (!response.ok) throw new Error('Failed to fetch files');
                return await response.json();
            } catch (error) {
                console.error('Error fetching file list:', error);
                return [];
            }
        }

        // Display file list
        function displayFileList(files) {
            const listEl = document.getElementById('fileList');
            
            if (files.length === 0) {
                listEl.innerHTML = '<div class="text-gray-500 text-sm">No files found</div>';
                return;
            }

            listEl.innerHTML = files.map(file => `
                <div 
                    class="p-3 border rounded-lg cursor-pointer hover:bg-blue-50 transition ${currentFile === file ? 'bg-blue-100 border-blue-400' : ''}"
                    onclick="loadFile('${file}')"
                >
                    <div class="font-medium text-sm">${file}</div>
                    <div class="text-xs text-gray-500">Click to view</div>
                </div>
            `).join('');
        }

        // Load and display file content
        async function loadFile(filename) {
            currentFile = filename;
            const source = document.getElementById('sourceSelect').value;
            
            try {
                // Simulate loading file content
                // In production, fetch from: `/${source}/${filename}`
                const data = await fetchFileContent(source, filename);
                allFiles[filename] = data;
                displayRoutes(data.routes || []);
                
                // Update file list highlighting
                displayFileList(Object.keys(allFiles));
            } catch (error) {
                console.error('Error loading file:', error);
                document.getElementById('routeList').innerHTML = 
                    '<div class="text-red-500">Error loading file</div>';
            }
        }

        // Fetch file content from API
        async function fetchFileContent(directory, filename) {
            try {
                const response = await fetch(`${MOCK_SERVER}/api/file/${directory}/${filename}`);
                if (!response.ok) throw new Error('Failed to fetch file');
                return await response.json();
            } catch (error) {
                console.error('Error fetching file content:', error);
                return { routes: [] };
            }
        }

        // Display routes
        function displayRoutes(routes) {
            allRoutes = routes;
            const listEl = document.getElementById('routeList');
            
            if (routes.length === 0) {
                listEl.innerHTML = '<div class="text-gray-500 text-sm">No routes in this file</div>';
                return;
            }

            listEl.innerHTML = routes.map((route, index) => `
                <div class="border rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 text-xs font-semibold rounded ${getMethodColor(route.method)}">
                                ${route.method}
                            </span>
                            <code class="text-sm font-mono text-gray-700">${route.path}</code>
                        </div>
                        <span class="px-2 py-1 text-xs rounded ${getStatusColor(route.status)}">
                            ${route.status}
                        </span>
                    </div>
                    
                    ${route.full_url ? `<div class="text-xs text-gray-500 mb-2">URL: <span class="font-mono">${route.full_url}</span></div>` : ''}
                    ${route.host ? `<div class="text-xs text-gray-500 mb-2">Host: <span class="font-mono">${route.host}</span></div>` : ''}
                    ${route.response_time_ms ? `<div class="text-xs text-green-600 mb-2">‚ö° ${route.response_time_ms}ms</div>` : ''}
                    ${route.description ? `<div class="text-sm text-gray-600 mb-2">${route.description}</div>` : ''}
                    
                    <div class="mt-3 space-y-2">
                        ${route.query_params && Object.keys(route.query_params).length > 0 ? `
                            <button 
                                onclick="toggleQueryParams(${index})" 
                                class="text-xs text-indigo-600 hover:text-indigo-800"
                            >
                                Query Parameters ‚ñº
                            </button>
                            <div id="query-${index}" class="hidden mt-2">
                                <pre class="bg-gray-50 p-2 rounded text-xs overflow-x-auto">${formatJSON(route.query_params)}</pre>
                            </div>
                        ` : ''}
                        
                        ${route.request_headers ? `
                            <button 
                                onclick="toggleRequestHeaders(${index})" 
                                class="text-xs text-orange-600 hover:text-orange-800"
                            >
                                Request Headers ‚ñº
                            </button>
                            <div id="req-headers-${index}" class="hidden mt-2">
                                <pre class="bg-gray-50 p-2 rounded text-xs overflow-x-auto">${formatJSON(route.request_headers)}</pre>
                            </div>
                        ` : ''}
                        
                        <button 
                            onclick="toggleResponse(${index})" 
                            class="text-xs text-blue-600 hover:text-blue-800"
                        >
                            Response Body ‚ñº
                        </button>
                        <div id="response-${index}" class="hidden mt-2">
                            <pre class="bg-gray-50 p-2 rounded text-xs overflow-x-auto">${formatJSON(route.response)}</pre>
                        </div>
                        
                        ${route.response_headers ? `
                            <button 
                                onclick="toggleResponseHeaders(${index})" 
                                class="text-xs text-teal-600 hover:text-teal-800"
                            >
                                Response Headers ‚ñº
                            </button>
                            <div id="resp-headers-${index}" class="hidden mt-2">
                                <pre class="bg-gray-50 p-2 rounded text-xs overflow-x-auto">${formatJSON(route.response_headers)}</pre>
                            </div>
                        ` : ''}
                        
                        ${route.request_body ? `
                            <button 
                                onclick="toggleRequestBody(${index})" 
                                class="text-xs text-purple-600 hover:text-purple-800"
                            >
                                Request Body ‚ñº
                            </button>
                            <div id="request-${index}" class="hidden mt-2">
                                <pre class="bg-gray-50 p-2 rounded text-xs overflow-x-auto">${formatJSON(route.request_body)}</pre>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${route.captured_at ? `
                        <div class="text-xs text-gray-400 mt-3">
                            Captured: ${new Date(route.captured_at).toLocaleString()}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Toggle response visibility
        function toggleResponse(index) {
            const el = document.getElementById(`response-${index}`);
            el.classList.toggle('hidden');
        }

        // Toggle request body visibility
        function toggleRequestBody(index) {
            const el = document.getElementById(`request-${index}`);
            el.classList.toggle('hidden');
        }
        
        // Toggle query params visibility
        function toggleQueryParams(index) {
            const el = document.getElementById(`query-${index}`);
            el.classList.toggle('hidden');
        }
        
        // Toggle request headers visibility
        function toggleRequestHeaders(index) {
            const el = document.getElementById(`req-headers-${index}`);
            el.classList.toggle('hidden');
        }
        
        // Toggle response headers visibility
        function toggleResponseHeaders(index) {
            const el = document.getElementById(`resp-headers-${index}`);
            el.classList.toggle('hidden');
        }

        // Clear captures
        async function clearCaptures() {
            if (!confirm('Are you sure you want to clear all live captures?')) {
                return;
            }
            
            try {
                const response = await fetch(`${PROXY_SERVER}/capture/clear`, { method: 'POST' });
                if (response.ok) {
                    alert('Captures cleared successfully!');
                    loadFiles();
                } else {
                    alert('Failed to clear captures');
                }
            } catch (error) {
                alert('Error: Proxy server not running');
            }
        }

        // Filter routes based on search
        function filterRoutes() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allRoutes.filter(route => 
                route.path.toLowerCase().includes(search) ||
                route.method.toLowerCase().includes(search) ||
                (route.description && route.description.toLowerCase().includes(search))
            );
            displayRoutes(filtered);
        }

        // Format JSON with syntax highlighting
        function formatJSON(obj) {
            const json = JSON.stringify(obj, null, 2);
            return json
                .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
                .replace(/: "([^"]*)"/g, ': <span class="json-string">"$1"</span>')
                .replace(/: (\d+)/g, ': <span class="json-number">$1</span>')
                .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>')
                .replace(/: null/g, ': <span class="json-null">null</span>');
        }

        // Get color for HTTP method
        function getMethodColor(method) {
            const colors = {
                GET: 'bg-green-100 text-green-800',
                POST: 'bg-blue-100 text-blue-800',
                PUT: 'bg-yellow-100 text-yellow-800',
                PATCH: 'bg-orange-100 text-orange-800',
                DELETE: 'bg-red-100 text-red-800'
            };
            return colors[method] || 'bg-gray-100 text-gray-800';
        }

        // Get color for status code
        function getStatusColor(status) {
            if (status >= 200 && status < 300) return 'bg-green-100 text-green-800';
            if (status >= 300 && status < 400) return 'bg-yellow-100 text-yellow-800';
            if (status >= 400 && status < 500) return 'bg-orange-100 text-orange-800';
            if (status >= 500) return 'bg-red-100 text-red-800';
            return 'bg-gray-100 text-gray-800';
        }

        // Save captures
        async function saveCaptures() {
            try {
                const response = await fetch(`${PROXY_SERVER}/capture/save`, { method: 'POST' });
                if (response.ok) {
                    alert('Captures saved successfully!');
                    loadFiles();
                } else {
                    alert('Failed to save captures');
                }
            } catch (error) {
                alert('Error: Proxy server not running');
            }
        }

        // Copy captured files to configs
        function copyToConfigs() {
            // This would normally call a backend endpoint
            alert('Copy captured/*.json to configs/ directory to use as mocks');
        }

        // Update statistics
        function updateStats() {
            const totalFiles = Object.keys(allFiles).length;
            const totalRoutes = Object.values(allFiles).reduce((sum, file) => 
                sum + (file.routes ? file.routes.length : 0), 0);
            
            document.getElementById('stats').innerHTML = `
                <div>Total Routes: <span class="font-mono font-bold">${totalRoutes}</span></div>
                <div>Total Files: <span class="font-mono font-bold">${totalFiles}</span></div>
                <div>Source: <span class="font-mono">${document.getElementById('sourceSelect').value}</span></div>
            `;
        }

        // Initialize on load
        window.onload = () => {
            checkStatus();
            loadFiles();
            
            // Refresh status every 5 seconds
            setInterval(checkStatus, 5000);
        };
    </script>
</body>
</html>